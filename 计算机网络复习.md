# **计算机网络复习**

---

---

## 概述

### 1.1-2互联网概述

> 三大类网络：
>
> - 电信网络，
>
> - 有线电视网络，
>
> - 计算机网络
>
>   
>
> 互联网（Internet）和互连网(internet):
>
> - Internet是最大的计算机网络（覆盖全球）
>
> - 互联网具有**连通性**和**共享**（用户终端好像彼此连通，资源共享）
>
>   
>
> 计算机网络：
>
> - 由若干==**节点**==和连接节点的**==链路==**组成
>
> - 节点包括：主机（与网络相连的计算机），集线器，交换机，路由器，网关等
>
> - 网络和网络*通过**路由器**相连*->互连网（网络的网络）
>
>   网络互连目的是**实现计算机之间的相互交换信息**，因此不仅限于物理层面的互连，还包括软件（应用，进程）间的连接交换
>
> 

---



### 1.3互联网发展阶段

> 起源：美国国防部创建的单个分组交换网ARPANET
>
> 第二阶段：建成了三级结构的互联网：主干网，地区网，校园网
>
> 第三阶段：形成全球范围内的多层次ISP结构的互联网（主干-地区-本地）
>
> <img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516104608747.png" alt="image-20230516104608747" style="zoom:50%;" align="left"/>
>
> ISP:互联网服务提供商（分配给用户IP地址，使用户能够接入网络）
>
> IXP:互联网交换点（连接两个ISP网络并交换分组，转接服务）
>
> WWW:万维网
>
> 
>
> 互联网标准化工作：
>
> 1. 互联网草案
> 2. 建议标准（RFC文档）
> 3. 互联网标准



---



### 1.4**互联网组成**

| 组成 | 边缘部分       | 核心部分             |
| ---- | -------------- | -------------------- |
| 节点 | 主机，服务器   | 大量网络和路由节点   |
| 功能 | 用户直接使用   | 为边缘部分提供服务   |
| 服务 | 通信，资源共享 | 提供连通性和资源共享 |



主机间的通信/资源共享 本质：

- 主机A的某个进程与主机B的某个**进程**进行**通信**

#### 1.4.1**边缘部分通信方式**

##### **客户-服务器方式（C-S）**

客户是服务请求方，服务器是服务提供方（实际都是计算机进程）

1.客户程序：必须知道服务器程序的地址，向服务器发起通信（请求服务），不复杂

2.服务器程序：可同时处理多个客户的请求，被动接受来自客户的通信请求，复杂

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516104700826.png" alt="image-20230516104700826" style="zoom: 25%;" />

##### **对等连接方式（P2P）**

不区分服务请求方和服务提供方，主机可同时充当客户和服务器

###### 

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516105154442.png" alt="image-20230516105154442" style="zoom:25%;" align="left"/>

#### 1.4.2**核心部分**

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516111222995.png" alt="image-20230516111222995" style="zoom: 33%;" /><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516111845006.png" alt="image-20230516111845006" style="zoom:33%;" />

| 交换技术 | 电路交换                                             | 报文交换                                                     | 分组交换                                                     |
| -------- | ---------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 连接     | 有连接                                               | 无连接                                                       | 无连接                                                       |
| 方法     | 建立连接->通话->释放连接                             | 存储转发（整个交换）                                         | **==存储转发，分组交换==**                                   |
| 特点     | 整个报文连续地从起点直达终点                         | 整个报文逐个节点的传输（先存储，查找**转发表**后转到下一节点） | 报文分组，单个分组（添加**首部**）进行存储转发               |
|          | 传输效率低                                           | 报文交换时延较长（联想:发电报）                              | 高效灵活迅速可靠                                             |
|          | 预先分配**带宽**，通话的全部时间内，始终占用通信资源 |                                                              | 动态分配带宽，每个分组独立选择路径（”多路到达“），不需建立连接，使用可靠的网络协议 |
|          | 不加地址                                             | 只加一个地址                                                 | 每组都要加地址（增加控制信息），存在排队延迟                 |

>**存储转发过程**
>
>1. 路由器收到一个分组，先暂时**存储**一下
>2. 检查其首部，查找**转发表**
>3. 按照首部中的<u>目的地址</u>，找到合适的接口**转发**出去，把分组交给下一路由器

PS:电路交换+多路复用技术，占用多路信号中的某一路。



---



### 1.5我国计算机网络发展（略）



### 1.6计算机网络分类

![image-20230516111550081](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516111550081.png)

---



### 1.7计算机网络性能

#### 1.7.1性能指标

##### **速率**

>数据传输率，单位：`bit/s`
>
>注意速率单位换算：
>1B/s = 8bit/s  
>1kbit/s=10^3^bit/s
>1Mbit/s=10^6^bit/s
>
>同时比特(数据量单位)换算：
>1B=8b
>1`GB`=2^10^`MB`=2^10^\*2^10^`KB`=2^10^\*2^10^\*2^10^`B`

##### 带宽

>两种意思：
>
>1. **频域**。信号的频带宽度（在<u>[频分多用]()</u>中涉及），单位`HZ`
>2. **时域**。通道传输数据的能力，表示单位时间内网络中某信道的==**最高数据率**==，单位`bit/s`
>
>同理的：1kHZ = 10^3^HZ

##### 吞吐率

>单位时间内通过某个网络的数据量，受到网络带宽和网络额定速率的限制
>
>**由网络中的最小速率链路决定**

##### 时延

>数据从网络一端传到另外一端所需时间
>
>`总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延`
>
>**发送时延**
>
><u>高速链路提升的是数据的发送速率</u>，并非传播速率（仅与传播媒介有关）
>
>==首端发送出去-末端发送出去==
>
>**计算时发送速率取链路中较小者**
>
>![image-20230516170828652](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516170828652.png)
>
>**传播时延**
>
>==末端发送出去-末端被接收==
>
>传播时延与信号的发送速率无关
>
>![image-20230516171005060](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516171005060.png)
>
>
>
>**处理时延**
>
>**排队时延**
>
>![image-20230516171047617](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516171047617.png)
>
>![image-20230516170637115](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230516170637115.png)
>
>四种时延谁占主导不固定

##### 时延带宽积

>`时延带宽积 = 传播时延 * 带宽 （bit）`
>**以比特为单位的链路长度**
>
>![image-20230517161629645](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230517161629645.png)

##### 往返时间RTT

> ![image-20230517161606240](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230517161606240.png)
> 



##### 利用率

>网络利用率，信道利用率（按时间算占比）
>
>![image-20230517164850609](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230517164850609.png)
>**利用率过高会产生非常大的时延**
>
>![image-20230517165019650](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230517165019650.png)



#### 1.7.2非性能指标（略）



---



### 1.8==计算机网络体系结构==

体系结构：计算机网络各层+协议 （**`层次组成+功能`**）

**协议**：定义了发送方、接收方和所有中间设备为了高效通信需要遵守的规则（==**语法、语义、时效**==）

- 网络——》必有协议
- 两种形式：文字描述（对人），程序代码（计算机）
- 传输信息：控制信息+数据信息

协议分层：在通信复杂时，需要将任务分层，每层需要一个协议。

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d2836851-4c0c-4357-824e-c02bcd9ddb95/Untitled.png)

![image-20230517183954927](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230517183954927.png)

- ***模块化分工***，将任务分配给每块，每块（层）相当一个有输入输出的独立盒子，且同样的输入得到相同的输出
- 一层能够接受较低一层的一系列服务（但是看不见），同时向较高层提供服务。（相互独立）
- ==协议是水平的，服务是垂直的==
- **主要功能**
  - 差错控制（数据链路层，传输层[TCP]()）
  - 流量控制(TCP)             拥塞控制
  - 分段与重装（网络层）
  - 复用与分用（传输层）
  - 连接建立与释放

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/54738271-72f4-474f-b6b0-44160c048412/Untitled.png)

**TCP/IP协议簇的层次**

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/544823bb-9105-4741-ba06-21f55b8ebded/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ffb5524f-5f16-4d4e-bb3a-0b235382750b/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f548ad2e-faee-4f84-b69a-590033268c48/Untitled.png)

![image-20230517190109568](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230517190109568.png)

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230518111452303.png" alt="image-20230518111452303" style="zoom:50%;" />

![image-20230518111948818](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230518111948818.png)

>**应用层**
>
>- 端到端的连接
>- 两个进程之间的通信
>- 协议
>	- 超文本传输协议（HTTP）
>	- 简单邮件传输协议（SMTP）
>	- 文件传输协议（FTP）
>	- 简单网络管理协议（SNMP）
>	- 因特网组管理协议（IGMP）
>
>- 域名系统（DNS）
>
>
>**传输层**
>
>- 端到端的连接
>
>- 复用，分用
>
>- 传输层分组：段/用户数据报
>
>- 端口号
>
>- 协议
>
>  - 传输控制协议（TCP） 
>
>    - 有连接，可靠传输
>
>    - 流量控制 差错控制 拥塞控制
>    - 报文段
>
>
>  - 用户数据报协议（UDP）
>
>    -  无连接 简单
>
>    - 尽最大努力交付
>
>    - 用户数据报
>
>
>  - 流控制传输协议（SCTP）
>
>
>**网络层**
>
>- 主机到主机
>- 路由器为每个分组选择最好的路径（路由选择，转发）
>- IP数据报
>- IP地址
>- 协议
>
> 1. 因特网协议（IP） 无连接
>
> 2. 因特网控制报文协议（ICMP）
>
> 3. 因特网组管理控制协议（IGMP）
>
> 4. 动态主机配置协议（DHCP）
>
> 5. 地址解析协议（ARP）
>- 单播、多播
>
>**数据链路层**
>
>- 相邻节点间的可靠通信
>
>- 封装成帧
>- 交换机
>- MAC地址
>
>**物理层**
>
>- bit传输
>- 物理媒体如何连接、多少引脚
>- 集线器
>



---

### 课后习题

>10.试在下列条件下比较电路交换和分组交换。要传送的报文共 x（bit）。从源点到终点共经过 k 段链路，每段链路的传播时延为 d（s），数据率为 b(b/s)。在电路交换时电路的建立时间为 s(s)。在分组交换时分组长度为 p(bit)，且各结点的排队等待时间可忽略不计。问在怎样的条件下，分组交换的时延比电路交换的要小？（提示：画一下草图观察 k 段链路共有几个结点。）(可以参照第10题上面的计算公式）
>
>`答：线路交换时延：kd+x/b+s, 分组交换时延：kd+(x/p)(p/b)+ (k-1)(p/b)，`
>`其中(k-1)(p/b)表示 K段传输中，有(k-1)次的储存转发延迟，`
>`当 s>(k-1)(p/b)时，分组交换的时延比电路交换的时延小，当x>>p,相反。`
>
>
>
>**解析：**连续发送多比特信息/连续分组发送多比特信息 和 发送1比特信息的==**传播时延相同**==
>**`传播时延：末端信息发送——末端信息被接收（末端信息走完信道所用时间，与数据量大小无关）`**
>
>主机在**一段**链路上连续分组发送信号： 
>`总时延 = 所有分组的发送时延 + 信号在链路上的传播时延（1个）`
>
>主机在**m段**链路上连续分组发送信号：
> `总时延 = （一个分组的发送时延 * 分组数） + 信号在链路上的总传播时延（即 m * 单条链路传播时延）+ （一个分组的发送时延 * 转发次数（即m-1））`
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230518102746847.png" alt="image-20230518102746847" style="zoom:50%;" />



> 11.在第10题的分组交换网中，设报文长度和分组长度分别为x和(p+h)(bit)，其中p为分组的数据部分的长度，h为每个分组所添加的首部长度，与p的大小无关。通信的两端共经过k段链路。链路的数据率为b(bit/s)，但传播时延和节点的排队时间均可忽略不计。若打算使总的时延为最小，问分组的数据部分长度p应取为多大？(可以参照第10题上面的计算公式）
>
> `答：总时延D表达式，分组交换时延为：D= (x/p)((p+h)/b)+ (k-1)(p+h)/b ，`
> `D对p求导后，令其值等于0，求得p=[(xh)/(k-1)]^0.5`



>![image-20230518105429161](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230518105429161.png)
>
>

---

>1-36 主机A到主机B的路径有三段路，其速率分别为2Mbit/s，1Mbit/s和500kbit/s。现在A向B发送一个文件。
>（1）试计算该文件传送的吞吐量。
>（2）设文件长度为10MB，而网络上没有其他流量。试问该文件从A传送到B大约需要多少时间？为什么这里只是计算大约的时间?
>
>解答：
>
>（1）由**最小速率链路决定**，即为 500kbit/s
>（2）**整个链路的传输速率按吞吐率计算**，所以大约时间：8 * 10 * 2^20^ bit  /  500 × 10^3^ bit / s = 167 s 





---

---

## 物理层

---

---

### 2.1基本概念

物理层的任务

> - **怎样**通过传输媒体传输数据
> - 屏蔽传输媒体、通信手段的差异（对上）
> - **主要任务**——确定传输媒体接口的有关特性
>   - 机械特性
>   - 电气特性
>   - 功能特性
>   - 过程特性
>
> 物理连接方式众多，传输媒介众多——物理层协议**（规程）**种类较多

`PS:数据在计算机内部多采用并行输入，但在通信网络上一般都是串行输入`



---

### 2.2数据通信的基础知识

#### 2.2.1数据通信系统的模型

> 首先可以看到一个数据通讯系统可以划分为三大部分：==**① 源系统、② 传输系统、③ 目的系统**==
>
> **(1) 源系统包括**
>
> - **源点**：源点设备产生要传输的数据
> - **发送器**：源点生成的数字比特流要通过发送器编码后才能在传输系统中传输，例如调制器
>
> **(2) 目的系统包括**
>
> - **接收器**：结束传输系统发送来的信号，并转换成能被目的设备处理的信息，如解调器
> - **终点**：终点设备从接收器获取传送来的数字比特流，然后把信息输出
>
> **(3) 专业术语补充**
>
> - **消息**：通信的目的是传送消息，如语音、文字、图像、视频等
>
> - **数据**：是**`运送消息的实体`**，即使用特定方式表示的信息，通常是有意义的符号序列
>
> - **信号**：数据电气或电磁的表现
>
> - - **模拟信号**（连续信号）：代表消息的参数取值是**`连续`**的
>   - **数字信号**（离散信号）：代表消息的参数的取值是**`离散`**的
>   - ==**码元**==：代表不同离散数值的基本波形（二进制编码的码元就是0和1两种状态）
>
> 



#### 2.2.2信道的基本知识

**信道**：用来表示向某个方向传送信息的媒体
**通信电路组成**：发送信道 + 接收信道

**三种信息交互方式**

| 方式   | 单工通信                                 | 半双工通信                                                   | 全双工通信                                                   |
| ------ | ---------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 特点   | 只有一个方向的通信（`无交互`）<br />A->B | 一方发送，一方接受（**`方向可交替`**）<br />通信双方**不能同时**发送或接受信息<br />A->B 或 B->A | 通信双方**可以同时**发送或接受信息<br />A->B和B->A可同时进行 |
| 信道数 | 一条                                     | 两条（`两个方向`）                                           | 两条（`两个方向`）                                           |
| 举例   | 电视广播                                 | 对讲机                                                       | 电话                                                         |

**基带信号**：来自<u>**信源**</u>的信号

- 数字信号

- 包含较多的低频分量

- 需要进行调制（满足信道）

**调制方法**

- 基带调制
  - 编码

  - 数字信号->数字信号

  - 变化后的信号还是基带信号

- 带通调制
  - 载波调制（移动频率范围）
  - 数字信号->模拟信号
  - 调制后的信号为带通信号




##### 常用的编码方式(基带调制)

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230518171444585.png" alt="image-20230518171444585" style="zoom:67%;" />

曼彻斯特和差分曼彻斯特编码方式的信号频率更高，且具有自同步能力（能从信号波形中提取出时间长度）

`PS：以太网采用曼彻斯特编码`

##### 基本的带通调制方式



<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230518171827957.png" alt="image-20230518171827957" style="zoom:67%;" />

`PS:调幅（AM），调频（FM），调相（PM）`



#### 2.2.3信道的极限容量

**`码元的传送速率越高，信号传输的距离越远，噪声干扰越大或传输媒体质量越差，在接收端的波形的失真就越严重`**

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519103745778.png" alt="image-20230519103745778" style="zoom: 50%;" align="left"/>

##### ==**三个公式**==

>1. **码元传输**的最高速率 = **2W （bit / s）**(不等于最高数据传输率，因为一个码元可能对应多位的比特信息)
>
>     ```
>     W为信道带宽（HZ）
>     超出该范围(2W)，会发生 码间串扰
>     ```
>
>     
>
>2. 信噪比 = **10 log~10~ (S/N)  (dB)**
>
>3. 信道的极限传输速率 **C = W log~2~ (1 + S/N)  (bit/s)**

公式含义

>**奈式公式：**
>`探索更加先进的编码方式，使每个码元携带更多比特的信息。`
>
>**香农公式：**
>`信道带宽或信噪比越大，信息的极限传输速率就越大
>有噪声干扰的信道，无法突破极限传输速率`

提高信息的传输速率

>- 多元制 
>  **`一个码元携带多个（n）比特的信息`**
>   此时:**==比特率 = log~2~n * 码元率==**
>
> - 提高信噪比
>
>- 提高信道带宽（HZ）

---

### 2.3物理层下面的传输媒体



#### 2.3.1导引型传输媒体

**导引型**：电磁波沿着固体媒介传播

- 双绞线
- 同轴电缆
- 光缆
- 架空明线



#### 2.3.2非导引型传输媒体

**非导引型**：电磁波采用无线传输

无线传输使用频段：

- 低—中—高—甚高—特高—超高—极高—tremendously

`无线信道传输数字信息时`要求**误码率**不大于可容许的范围

>- 信噪比越大，误码率越低
>- 调制技术的数据率越高，误码率越大
>- 移动通信——>改变无线信道的特性
>  - 要求设备物理层有一定自适应能力
>  - 微波接力



**微波通信**

>- 300 MHZ ~ 300 GHZ
>- 工作范围：2 GHZ ~ 40 GHZ
>- 直线传播
>- 多径效应——>信号失真

**短波通信**

>- 依靠电离层的反射

**卫星通信**

>- 通信距离远
>- 较大的传播时延

红外通信、激光通信......

### 2.4信道复用技术

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519141739907.png" alt="image-20230519141739907" style="zoom: 67%;" align="left"/>

频分多址（FDMA）

时分多址（TDMA）

统计时分复用（STMA）

**码分复用（CDMA）**

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519150411529.png" alt="image-20230519150411529" style="zoom:67%;" align="left"/>

- 划分比特时间，每个站分配一个码片序列（实现了扩频）
- 码片序列彼此`相互正交`（点乘 = 0）
- 比特 1 = 码片序列  比特0 = 码片序列反码
- 接收方 有所有站的码片序列（-1 1）

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519153235299.png" alt="image-20230519153235299" style="zoom:67%;" align="left"/>

- 接收方 有所有站的码片序列（-1 1）
- **将接受到的信息（各个发送信息的相加）与各个码片序列做点乘**（结果**除以序列的位数**）
  - 结果为0 ：该站未发送信息
  - 结果为1：该站发送比特 1
  - 结果为-1：该站发送比特0

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230520105431455.png" alt="image-20230520105431455" style="zoom:50%;" align="left"/>

---

### 2.5数字传输技术（非重点）

**(一) 早期数字传输系统**

- 在早期电话网中，从市话局到用户电话机的用户线是采用最廉价的双绞线电缆，而长途干线采用的是频分复用 FDM 的模拟传输方式
- 与模拟通信相比，数字通信无论是在传输质量上还是经济上都有明显的优势

- 目前，长途干线大都采用时分复用 PCM 的数字传输方式

- 脉码调制 PCM 体制最初是为了在电话局之间的中继线上传送多路的电话

**(二) 早期数字传输系统的缺点**

- 速率标准不一
- 不是同步传输

现代的传输网络的传输媒体：**光纤**

**同步光纤网(SONET)**：各级时钟都来自一个非常精确的主时钟，为光纤传输系统定义了同步传输的线路速率等级结构

**同步数字系列(SDH)**：由sonet为基础发展的国际标准

---

### 2.6宽带接入技术（非重点）



---

### 课后习题

>信道的最高码元传输率 = 2W （bit/s）
>若一个码元可携带n比特的信息，则**信道的数据传输率 = log~2~n * 波特率**
>
>信噪比（dB）= 10 log~10~(S/N) 
>噪声情况下信道的极限传输速率 = W log~2~(1 + S/N)
>==一般给出信噪比都是（dB），求出 S/N 后，才能代入香农公式==
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519160259721.png" alt="image-20230519160259721" style="zoom:50%;" align="left"/>
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519161313042.png" alt="image-20230519161313042" style="zoom:50%;" align="left"/>
>
>



>CDMA码分复用
>
>给定各个站点的码片序列，以及接收方收到的序列，求各个站点发送的数据
>
>- 将接收方收到的序列与各个站点的码片序列做内积运算
>- **`运算结果要除以 码片序列的位数`**
>  - 结果为0：站点未发送信息
>  - 结果为1：站点发送比特 1
>  - 结果为-1：站点发送比特 0
>
>
>
>16 . 共有4个站进行码分多址通信。4个站的码片序列为 A：（－1－1－1＋1＋1－1＋1＋1） B：（－1－1＋1－1＋1＋1＋1－1） C：（－1＋1－1＋1＋1＋1－1－1） D：（－1＋1－1－1－1－1＋1－1） 现收到这样的码片序列S：（－1＋1－3＋1－1－3＋1＋1）。问哪个站发送数据了？发送数据的站发送的是0还是1？
>
>```
>S•A=（＋1－1＋3＋1－1＋3＋1＋1）／8 = 1， A发送1`
>S•B=（＋1－1－3－1－1－3＋1－1）／8 = -1， B发送0`
>S•C=（＋1＋1＋3＋1－1－3－1－1）／8 = 0， C无发送`
>S•D=（＋1＋1＋3－1＋1＋3＋1－1）／8 = 1， D发送1`
>
>```
>
>![image-20230519162950129](C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230519162950129.png)



---

---

## 数据链路层

> **研究内容：**
>
> **`在同一个局域网中，分组怎样从一台主机传送到另一台主机，但不经过路由器转发`**
>
> **使用的信道及协议：**
>
> - [点对点信道（PPP协议）]()
> - [广播信道（CSMA/CD协议）](3.3.2CSMA/CD协议)
>
> <img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521083642435.png" alt="image-20230521083642435" style="zoom:50%;" align="left"/>
>
> **三个基本问题：**
>
> - 封装成帧
> - 透明传输
> - 差错检测
>
> **以太网相关知识及扩展**

---

### 3.1数据链路层的共同问题



#### 3.1.1数据链路和帧

链路：相邻两个结点间的一段物理线路（中间没有其他交换节点） 物理链路
数据链路：链路 + 通信协议 或  逻辑链路

- `由网络适配器（网卡，两层）实现这些协议`

**帧**——  ==点对点信道== 的数据链路层的**协议数据单元**

`以太网：MAC帧`

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521084347017.png" alt="image-20230521084347017" style="zoom: 50%;" align="left"/>

#### 3.1.2==三个基本问题==

以下给出三个问题的概念，解决方法在后续**结合协议**进行进一步讨论

##### 封装成帧

>
>
>封装成帧：在**数据部分**的前后分别添加首部和尾部
>
>- 首尾部 可进行帧定界
>- 首尾部 包含控制信息（格式看协议）
>
>  **`将比特组合成帧为单位传输——出错时只需重传出错的帧`**
>
>为保证传输效率，应当使<u>数据部分尽可能大于首尾部长度</u>
>
>每种数据链路层协议都规定了==**最大传送单元（MTU）**==
>
>- MTU是**<u>帧的数据部分</u>**的长度上限
>- 由于MTU的限制，网络层分组的长度不能超过某个值
>
>帧定界符：SOH,EOT
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521084646461.png" alt="image-20230521084646461" style="zoom:50%;" align="left"/>



##### 透明传输

><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521084803620.png" alt="image-20230521084803620" style="zoom:50%;" align="left"/>
>
>数据部分可能有和`帧定界控制字符`相同的序列部分——>错误的定界
>
>`透明：某一个存在的事物看起来却好像不存在`
>
>```
>在数据链路层透明传输数据：
>无论发送什么样的比特组合的数据，这些数据都能按照原样 没有差错 地通过这个数据链路层
>```
>
>方法：
>
>- 字节填充/字符填充：在数据部分中的“SOH”和“EOT”前插入一个转义字符“ESC”
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521085335906.png" alt="image-20230521085335906" style="zoom:50%;" align="left"/>



##### 差错检验

>两种差错
>
>- 比特差错（位错）：0变成1,1变成0
>- 传输查错（帧错）：出现==帧丢失、帧失序、帧重复==
>
>针对比特差错——**误码率（BER）**
>
>
>
>###### 位错 检错方法——**循环冗余检验（CRC）**
>
>- 生成多项式P（n位）——》数据算数左移（加n-1个0）
>- 模2相除得到余数（n-1位）作为**帧检验序列（FCS）**
>- 数据和FCS拼接
>
>举例：P(x) = x^4^+x^2^+1 则除数为（1 0 1 0 1）
>
>
>
>**检验方法：**将收到的==每一帧==都除以相同的除数（P），检查余数R
>
>- R = 0 ，未出错，接收
>- R != 0 ，出错，**丢弃**（有差错的帧没有被接收）
>- **实现帧的“无差错接受”**
> - 凡是接收端接受的帧均无差错
>
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521091132810.png" alt="image-20230521091132810" style="zoom:50%;" align="left"/>
>
>```
>对于通信质量较好的传输链路，改正差错的任务由上层协议（TCP）来完成；较差则在数据链路层使用确认和重传机制
>```
>
>



---

### 3.2点对点协议（==PPP==）



#### 3.2.1PPP协议的特点

**用户计算机——ISP**  通信时使用的数据链路层协议

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521091857498.png" alt="image-20230521091857498" style="zoom: 67%;" align="left"/>

##### **PPP协议应满足的要求**

- 简单
  - 不进行纠错，排序，流量控制
- ==封装成帧==
- ==透明性==
- 多种网络层协议
  - 对上支持。。。
- 多种类型链路
  - 对下可运行
- ==差错检测==
- 检测连接状态
- 最大传送单元（MTU）
- 网络层地址协商
- 数据压缩协商

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521092746089.png" alt="image-20230521092746089" style="zoom: 50%;" align="left"/><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230521092721267.png" alt="image-20230521092721267" style="zoom: 50%;" align="right"/>













==PPP协议不需要进行纠错，不需要设置序号，不需要进行流量控制。==

==PPP协议只支持**点对点**的链路通信，并且只支持**全双工通信**==



##### **PPP协议的组成**

- 将IP数据报（帧数据部分）封装到串行分组的方法
- ==链路控制协议（**LCP**）==
- ==网络控制协议（**NCP**）==





---

#### 3.2.2PPP协议的帧格式

##### 各个字段的意义

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230524163718602.png" alt="image-20230524163718602" style="zoom:67%;" align="left"/>

`定界符（7E）= 011111110`

对比：[MAC帧的格式（CSMA/CD）]()

##### 实现透明传输

- 字节填充

  - **异步传输**（`逐个字符`的传送，面向字节）
  - 转义符：7D H，即01111101 B
  - 信息字段中出现：
    - 0x7E->(0x7D 0x7E)
    - 0x7d->(0x7d **0x5d**)
    - ASICC码的控制字符（小于0x20）-> (0x7D 控制字符 )

- 零比特填充

  - **同步传输**（`一连串的比特连续`传送，面向比特）
  - 发送端扫描`数据字段`,只要有5个连续的1，立即填入一个0
  - 接收端对`数据字段`，发现5个连续的1，删除其后的0

  

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230524165128686.png" alt="image-20230524165128686" style="zoom:67%;" align="left"/>

#### 3.2.3工作状态（接入网）

PPP是接入网（用户-ISP）的数据链路层上使用的协议

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525101512175.png" alt="image-20230525101512175" style="zoom:50%;" align="left"/>

1. 用户拨号接入ISP，建立物理连接

2. 用户向ISP发送 链路控制协议LCP分组（封装成多个帧），建立LCP连接

   - 另一端发送响应

3. 网络控制协议NCP 给新接入的用户个人电脑分配一个临时的IP地址

4. 通信完毕：

   - **NCP**释放**网络层连接**
   - **LCP**释放**数据链路层连接**
   - 最后释放**物理层连接**
- **`PPP链路的起始和终止状态处于`==链路静止==`状态，用户和ISP之间不存在物理层连接`**

---

### 3.3使用广播信道的数据链路层



#### 3.3.1 局域网的数据链路层

**局域网特点**：网络为一个单位所有，且地理范围和站点数量有限

**局域网的优点：**

>1）具有广播功能
>
>2）便于系统的扩展和演变
>
>3）提高了系统的可靠性，可用性。生存性
>
>局域网的分类：星形网，环形网，总线网（最为著名的以太网就是总线网）
>
>传统以太网:10Mbit/s 速率的以太网

**共享信道**的方法：

- 静态划分信道（FDMA,TDMA,CDMA）

- 动态媒体接入控制（多点接入）——动态地分配

  1. 随机接入（需要解决碰撞）

  2. 受控接入（令牌）



以太网的两个标准

>DIX Ethernet V2(实际的)
>
>IEEE 802.3（推广的）

局域网的数据链路层划分为了两个子层——**逻辑链路控制层LLC和媒体接入控制层MAC层，**MAC层用来解决媒体输入相关的问题

##### **适配器的作用**

> １）适配器用来==连接计算机与局域网==；同时要能够实现以太网协议；
> ２）适配器和局域网之间的通信是通过双绞线或者电缆以**串行传输**的方式进行的；而适配器与计算机之间的通信是**并行方式**进行的，之所以适配器要能够进行两种数据传送方式之间的**串并行转化**；
> ３）网络上的数据率与计算机总线上的数据率不同，因此适配器要安装内存储器以进行两种速率下的**缓存功能**
> ４）适配器要能够实现以太网协议
> ５）计算机的硬件地址（**MAC地址**）就在适配器的ROM中；（计算机的软件地址IP地址，在计算机的存储器中）

   <img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230524230113988.png" alt="image-20230524230113988" style="zoom:50%;" align="left"/>









==**KEY: 由适配器来发送和接收帧**==

#### **3.3.2==CSMA/CD协议==**

[随机接入 — CSMA/CD协议bilibili](https://www.bilibili.com/video/BV1c4411d7jb?p=31&vd_source=dc9d01b5d2b30046d24bc42ae8ab5122)

广播通信方式：**总线**上所有计算机都能检测到某台计算机发送的数据

需求：在总线上实现一对多、==**一对一**==的通信

- 在帧的首部写明接收站的地址（MAC地址）
- 相匹配的计算机接受数据，其余选择丢弃



##### 以太网的通信特点

> - 采用**无连接方式**
>   - 不编号，不发送确认
>   - 尽最大努力的交付`（不可靠的交付）`（局域网信道通信质量好）
>   - 由高层决定差错帧是否重传（如TCP）->以太网将其视为新的数据帧发送
>   - **在同一时间只能允许一台计算机发送数据**(使用CSMA/CD协议)
> - 发送的数据采用**曼彻斯特编码**的信号



##### **==CSMA/CD==（载波监听多点接入/碰撞检测）要点** 

><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525085726827.png" alt="image-20230525085726827" style="zoom:50%;" align="left"/>
>
>- 多点接入——即**总线网络**的方式
>
>
>- 载波监听——每个站在发送前 和 发送的时候 都不断的检测信道是否有其他站点在发送信号
>
>
>- 碰撞检测——**边发送边监听**，若在信道上有至少两个站点同时发送信息便发生碰撞。一旦检测到碰撞，站点立即中断发送；
>
>- >  - 电磁波在1km的电缆传送的传播时延约为5μs（v = 2 * 10^8^ m/s） 
>  >
>  >  - 所以一个站点最长在发送信息之后的一个往返时间（即**两倍的端到端的传播时延**）内才能收到碰撞信号，所以一个站点在发送信号的一段时间内，是不确定是否会遭遇碰撞的；——即以太网发送的不确定性；而这段不确定是否会发生碰撞的时间称为**争用期（或碰撞窗口）**；
>  >
>  >  - ==在争用期（具体为51.2μs）内可传送**512bit**，即64字节 (10Mbit/s的以太网)==，所以发生碰撞的时间就在站点发送512bit的时间内（也就是说，如果站点在发送一个完整的512字节的过程中没有检测到碰撞信号，则说明以后的发送都不会发生碰撞，可以完整的发送完整个数据帧）
>  >
>  >  
>  >
>  >  - **对于接收端：凡是长度小于64字节的帧都是由于冲突而异常终止的无效帧**
>  >    - 一般发送数据>64B,小于则需要填充
>  >    - 发生碰撞时，可发送（32B/48B）人为干扰信号——表示发生了碰撞（==**强化碰撞**==）
>  >
>  >  - ==帧间最小间隔：9.6μs（**96bit**）==
>  >
>  >  
>  >
>  >  - 在争用期如果发生碰撞则双方都需要进行**重传操作**，而以太网使用的确定重传时间的方法称为**截断二进制指数退避算法；**
>  >
>  >  
>  
>  站点不能同时发送和接受数据（但必须边发送边监听）——==使用CSMA/CD协议的以太网只能进行**半双工通信**==
>
>**关键点：**
>
>1. 站点检测到冲突的时间
>
>  为数据传到该站点时的时间——端到端传播时延+发送时的时间  
>
>  max(发送时的时间)=端到端传播时延
>
>  **即最多为两倍的端到端传播时延**（取总线两端的站点——**争用期**）
>
>2. 实际发生冲突的时间
>
>3. 检测到冲突前，发送了多少数据
>
>  (检测到冲突的时间-发送时的时间) * 数据率（即带宽）
>
>
>```
>在动态退避的过程中，为了使所有的站点发送的每一个数据帧逗都能保证得到想要的发送结果信息（是否发生碰撞），则规定一个数据帧的最小长度应该为512bit，这样，每个站点在发送所有的数据帧时都能够在发送完之前知道是否发生了碰撞，是否需要重传（如果小于最小帧长64字节，则有可能在完全发送完之后才发生碰撞，这样发送站点就不知道发生了碰撞，即不会重传该帧），
>因此，在以太网中多点信道中，凡长度小于64 字节的帧都是由于冲突而发生异常终止的无效帧，在接收站点的适配器中即可方便判断出该结果；
>规定帧间最小间隔9.6μs，是为了使刚刚收到数据帧站点能够有时间对手的数据帧作出反应
>```
>
>强化碰撞
>
>——在发生碰撞之后除了立即停止发送数据之外，还要发送32bit或48bit 的人为干扰信号，目的是为了能够让所有站点都知道发生了碰撞
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525085326936.png" alt="image-20230525085326936" style="zoom:50%;" align="left"/>

**总线占用时间：T~B~ + T~J~ + t**



#### 3.3.3使用==集线器==的星型拓扑

>星型以太网10BASE-T：
>
>- 10Mbit/s 
>- 连接线上的信号是基带信号 
>- 双绞线
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525090830666.png" alt="image-20230525090830666" style="zoom:50%;" align="left"/><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525090907066.png" alt="image-20230525090907066" style="zoom: 50%;" align="right"/>

>
>
>
>
>
>
>
>
>
>
>
>
>
>
>##### 集线器的特点：
>
>- 集线器使用电子器件模拟实际电缆线的工作，所以使用集线器的以太网在逻辑上还是一个**总线网**，各站逻辑上共享总线。**使用CSMA/CD协议；**
>- 集线器的接口通过两对双绞线与计算机上的适配器相连；一个集线器像是一个**多接口**的转发器；
>- 集线器**工作在物理层**，每个接口只简单地转发比特，**不进行碰撞检测**，**不缓存**发送的信息
>- 集线器采用专门的芯片，进行自适应串音回波抵消；（使得同一接口的强信号不会对弱信号产生干扰）



#### 3.3.4以太网的信道利用率（降低参数a）

多个站在以太网上同时工作可能会发生碰撞——信道利用率 < 100%



成功发送一个帧需要**占据信道的时间**是T~0~（帧长/发送速率） + τ（单程端到端传播时延）

**参数a= τ / T~0~**

```
a→0，表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高。

a越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。
```

提高信道利用率——

- T~0~尽量大， τ 尽量小
- 数据率一定时（发送速率），以太网==连线的长度==受到限制（降低τ ），同时以太网的==帧长==不能过短（增大T~0~）



理想情况（不发生碰撞 不用CSMA/CD调度）

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525094247693.png" alt="image-20230525094247693" style="zoom:50%;" align="left"/>



#### 3.3.5以太网的MAC层

##### MAC层的硬件地址

- 固化在适配器中的ROM中=适配器地址

- 并不指明主机处在什么位置，而是相当于该主机的“名字” / 某个接口的标识符

- ==48位地址（6字节）==

>- 高24位（`组织唯一标识符`）由管理机构统一分配给各个厂家，低24位由厂家自行指派（`扩展标识符`）
>- 第一字节的最低有效位**（I/G位）**
>  - 0：单个站地址
>  - 1：组地址
>
>- 第一字节的最低第二位**（G/L位）**
>  - 0：全球管理
>  - 1：本地管理
>
>- 剩余46位构成**2^46^个地址**
>

适配器的过滤功能：适配器从网络上每收到一个MAC帧，先检查MAC帧中的目的地址，接受**发向本站的帧**

- 单播帧（一对一）  单地址
- 广播帧（一对全体）全1地址
- 多播帧（一对多）  组地址

```
PS:适配器的混杂模式——接受所有在以太网中传输的帧（窃听）。用于监视分析以太网上的流量
```



##### MAC帧的格式（以太网V2）6-6-2- -4

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525102816467.png" alt="image-20230525102816467" style="zoom:60%;" align="left"/>

对比：[PPP帧的格式]()

> 目的地址/源地址：6字节的MAC地址
>
> 类型字段：标志上一层使用的协议（如0x0800——IP）
>
> 数据字段：46字节~1500字节  （最小长度64字节-帧首部尾部18字节，MTU=1500B）
>
> FCS检验范围：整个MAC帧（不包括物理层插入的8字节字段）
>
> `无 帧长度字段：根据FCS字段往前数4个字节可得到结束位置`
>
> 前同步码：调整接收端的时钟频率



```
在以太网上传送数据时是以帧为单位传送的，且传送时各帧之间必须有一定的间隙，因此接收端只需找到帧开始定界符，其后连续到达的比特流都属于同一个MAC帧。可见以太网不需要使用帧结束定界符，也不需要使用字节插入来保证透明传输
```

无效的MAC帧：

- 数据字段的长度与长度字段的值不一致；

- 帧的长度不是整数个字节；

- 用收到的帧检验序列 FCS 查出有差错；

- 数据字段的长度不在 46 ~ 1500 字节之间。

- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。



---

### 3.4扩展的以太网



#### 3.4.1在物理层扩展

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525113516842.png" alt="image-20230525113516842" style="zoom:50%;" align="left"/>

- 扩展主机和集线器之间的距离——使用光纤（一对光纤和一对光线调制解调器）

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525113544624.png" alt="image-20230525113544624" style="zoom:50%;" align="left"/>

- 使用多个集线器——多级星形结构的以太网

  > - **优点**
  >
  >   - 使原来属于不同**碰撞域**（冲突域）的计算机能够跨碰撞域通信。
  >
  >   - 扩大了以太网覆盖的地理范围。
  >
  > - **缺点**
  >
  >   - 碰撞域增大了，总的吞吐量未提高。（如三个以太网总的最大吞吐量为30Mbit/s,相连后为10Mbit/s）
  >
  >   - 如果使用不同的以太网技术（如数据率不同），那么就不能用集线器将它们互连起来。

  ```
  碰撞域（collision domain）又称为冲突域，指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络。碰撞域越大，发生碰撞的概率越高。
  ```

  

#### 3.4.2在数据链路层扩展==（交换机）==



##### 以太网交换机的特点

>- 工作在数据链路层
>
>- 相当于多端口的网桥
>
>  - 端口可以连接**主机**，也可以连接**其他交换机**
>
>- 采用==**全双工通信方式**==
>
>- 相互通信的主机都独占传输媒体，无碰撞地传输数据
>
>- 即插即用，交换表
>
>- **独享带宽**
>
>  如：10个用户接入以太网，使用交换机（`集线器`），每个**端口**到主机的带宽都是10 Mbit/s（`1 Mbit/s`），交换机(集线器)总容量——100 Mbit/s（`10 Mbit/s`）
>
>  <img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525122959332.png" alt="image-20230525122959332" style="zoom:50%;" align="left"/>



##### 以太网交换机的==自学习功能==

交换表的项目：目的MAC地址，转发端口，有效时间

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525123045919.png" alt="image-20230525123045919" style="zoom:40%;" align="left"/>

| 目的MAC地址 | 转发端口 | 有效时间 |
| ----------- | -------- | -------- |
| A           | 1        |          |
| C           | 2        |          |

==起始为空，先缓存帧，查找交换表，每次**写入帧的源主机信息**（表中没有的）==

- A向B发送帧
  - 查找交换表，没有B的地址
  - 将A的`MAC地址` 和 `端口号`写入交换表
  - 交换机向其余端口**广播**这个帧
- C向A发送帧
  - 查找交换表，有A的地址
  - 同上，写入源C的信息
  - 交换表中有目的地址和对应端口号，**转发**到对应端口

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525123208270.png" alt="image-20230525123208270" style="zoom:55%;" align="left"/>

**注意：**

- 端口可能会更换主机
  - 交换表写入一个项目就记下当时时间
  - 超过有效时间**自动删除**
- 自学习过程可能导致**兜圈子**
  - 冗余的链路（增加网络可靠性）->兜圈子
  - 使用==生成树协议STP==（使路径为 无环路的树状结构）



##### 从总线以太网到星形以太网

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230525123339427.png" alt="image-20230525123339427" style="zoom:60%;" align="left"/>

---

### 3.5高速以太网(略)

---

---



## 网络层

主要问题：

>- 提供可靠/不可靠的通信
>- IP地址
>- 路由选择
>

重点：

- IP地址分配
- IP数据报分片
- 路由转发过程（下一跳）
- 路由选择算法（尤其是RIP路由表更新过程）
- 理解VPN和NAT



### 4.1网络层的几个概念



#### 4.1.1网络层提供的两种服务

网络层的设计思路：网络层要设计得尽量简单，向其上层只提供**简单灵活的，无连接的，尽最大努力交付**的数据报服务

>- 不需建立网络层连接
>- **分组相互独立**，可走不同的路径
>  - 每个分组的首部必须携带目的主机的完整地址
>- 网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），也不保证分组传送的时限。
>  - 由主机中的**运输层负责可靠的通信**。（可靠通信交由用户主机实现）

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527093717415.png" alt="image-20230527093717415" style="zoom:67%;" align="left"/>

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527094034953.png" alt="image-20230527094034953" style="zoom:42%;" align="left"/><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527094120848.png" alt="image-20230527094120848" style="zoom:42%;" align="left"/>















#### 4.1.2网络层的两个层面

==不同网络间的主机通信——路由器转发分组——查找转发表——路由表——路由选择协议，交换路由信息==

**路由器间传送的信息：**

- 转发源主机和目的主机之间所传送的数据（即分组）
- 传送路由信息（创建、更新路由表）

网络层抽象划分：数据层面，控制层面（plane）

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527094820685.png" alt="image-20230527094820685" style="zoom:50%;" align="left"/>
数据层面：**独立地**根据本路由器的转发表转发分组（**硬件**工作）
控制层面：依靠多个路由器**协同运作**，创建路由表（**软件**工作）









<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527095450943.png" alt="image-20230527095450943" style="zoom:50%;" align="left"/>
**软件定义网络SDN**：

逻辑上集中的**远程控制器**代替路由器上的路由选择软件

路由器工作：收到分组，查找转发表，转发分组
远程控制器：计算出最佳的路由，在每一个路由器中生成其正确的转发表。





---

### 4.2==网际协议IP==

#### **与协议IP配套使用的协议：**

>- 地址解析协议 ==**ARP**==<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527100555786.png" alt="image-20230527100555786" style="zoom:67%;" align="right"/>
>- 网际控制报文协议 ==**ICMP**==（差错报告）
>- 网际组管理协议 ==**IGMP**==（多播）
>
>`IP 经常使用到 ARP; ICMP, IGMP要使用协议 IP`
>
>

#### 4.2.1虚拟互联网络

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527101317888.png" alt="image-20230527101317888" style="zoom:50%;" align="left"/>

解决方案：使用**中间设备**互联异构网络

##### **中间设备**

>- 物理层：转发器
>- 数据链路层：网桥/桥接器，交换机
>- 网络层：路由器
>- 网络层以上：网关

转发器、网桥或交换机仅把一个网络扩大了，仍然是一个网络
网络互连一般指用**路由器**进行网络互连和路由转发



<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527102305696.png" alt="image-20230527102305696" style="zoom:50%;" align="left"/>

由路由器相连网络，==参与互联的计算机都使用相同的**网际协议IP**==——在网络层上看起来像是一个统一的网络（**虚拟互联网络**），即IP网

- 在IP网的上层使用**TCP协议**，即为现在的互联网



<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527102702506.png" alt="image-20230527102702506" style="zoom:50%;" align="left"/>

源主机将IP数据报发送给目的主机：

- 不需要经过任何路由器（网络内）：**直接交付**
- 需要经过路由表转发：**间接交付**（最后还是直接交付）
- 分组在传送途中每一次转发：**一跳**



#### 4.2.2IP地址

##### 发展简述：

>- 32位 {<网络号>,<主机号>}
>  - 分类的IP地址
>    - A,B,C，D,E
>
>  - 无分类编址CIDR
>    - 网络前缀 + 主机号
>    - 地址掩码
>    - 构造超网
>
>- IPv6
>
>

---

##### IPv4地址及其表示方法

IP地址：连接到互联网上的主机（或路由器） **接口**的唯一标识符（32位）

- ==若主机或路由器同时连接了多个网络，则对应有多个接口，即有多个IP地址==

**点分十进制**记法：32位每8位——十进制

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527103942654.png" alt="image-20230527103942654" style="zoom:50%;" align="left"/>



32位IP地址结构：

>- 网络号：标志主机（或路由器）所连接到的网络(net-id)
>- 主机号：标志该主机（或该路由器）(host-id)
>- 表示连接到**某个网络上的一个主机（或路由器）**
>- ==一个IP地址在整个互联网的范围内都是唯一的==(接口)
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527104335575.png" alt="image-20230527104335575" style="zoom:50%;" align="left"/>
>
>

---

##### 分类的IP地址

>- **主机号：**
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527104738178.png" alt="image-20230527104738178" style="zoom:50%;" align="left"/>
>
>- **范围**
>
>​       <img src="C:\Users\86188\AppData\Local\Temp\WeChat Files\fe7142a25cd857ab0d77a88b14e6091.jpg" alt="fe7142a25cd857ab0d77a88b14e6091" style="zoom:67%;" />
>
>A类地址 可指派（分配）的网络号 不能全0（==网络号000...0表示本主机==），不能全1（==网络号为01111111用于环回测试==）
>
>B,C类 可指派的网络号 **可以全1，可以全0**
>
>>**注意：**
>>
>>指派**网络号**时，**注意A类**
>>
>>- A类网络地址中， 网络号 **0** **和** **127** 是保留地址，不指派。0表示“本网络”，127保留作为本地环回测试地址。
>>
>>- B类网络地址中，网络号 **128.0**可指派。
>>
>>- C类网络地址中，网络号**192.0.0** 可指派。
>>
>>指派**主机号**时，==都要扣全 **0** 和全 **1**== ，全 0和全 **1** 有特殊含义和用途。
>>
>>
>
>- **特殊IP地址**
>
><img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527104942306.png" alt="image-20230527104942306" style="zoom:50%;" align="left"/>
>
>==网络号”全1“的范围不包括前几个标志位==
>分类网络**只有A类网络的网络号才可能全0**
>
>主机号全0：表示该网络地址
>主机号全1：表示广播
>
>问题：各类网络可使用的主机数量固定，极其不灵活
>
>- 解决方案：使用==划分子网==的方法
>- 主机号分为<子网号>+<主机号>

<img src="C:\Users\86188\AppData\Local\Temp\WeChat Files\fe7142a25cd857ab0d77a88b14e6091.jpg" alt="fe7142a25cd857ab0d77a88b14e6091" style="zoom:67%;" align="left"/>

划分子网：从主机号借用几位作为子网号

- 定长的子网掩码（由划分子网数决定子网号位数——所有子网共用一个子网掩码）
- 变长的子网掩码（由子网中的主机号数决定子网号位数——可不同）
  - ==注意计算主机号位数时，要加上全0和全1==
    - **==n台主机，对应位数为[log~2~(n+2)]~上取整~==**
  - ==后续划分地址块，每块大小**只看主机号位数**，不看实际的主机数==
- <img src="C:\Users\86188\AppData\Local\Temp\WeChat Files\5fc8d41423402268d3927785ba552cc.jpg" alt="5fc8d41423402268d3927785ba552cc" style="zoom:50%;" align="left"/>
- <img src="C:\Users\86188\AppData\Local\Temp\WeChat Files\7aacb07f83f87be323373bd84e189a0.jpg" alt="7aacb07f83f87be323373bd84e189a0" style="zoom:90%;" align="left"/>

---

##### 无分类编址CIDR

格式：=={<网络前缀>,<主机号>}==

- **网络前缀位数n不固定**
- 斜线记法：IP地址\n——表明网络前缀有n位

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527110817681.png" alt="image-20230527110817681" style="zoom:50%;" align="left"/>

==不分类，但是可以组块==

- CIDR把**网络前缀都相同**的所有连续IP地址组成一个==“CIDR地址块”==
- 已知CIDR地址块中的一个地址——得到改地址块的主机号范围

<img src="C:\Users\86188\AppData\Local\Temp\WeChat Files\d918e1b9b03bbad62be02d6fe33a578.jpg" alt="d918e1b9b03bbad62be02d6fe33a578" style="zoom:50%;" />

> 给定一个CIDR记法的IP地址（十进制）
>
> - 写出二进制形式
> - 根据斜线右边得到网络前缀的位数
> - 分开，得到网络前缀部分和主机号部分

计算机看不懂斜线记法->使用32位的==**地址掩码**==

斜线后的数字=地址掩码中1的个数（高位）

==二进制的IP地址与地址掩码做按位AND运算——网络地址==

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527222600068.png" alt="image-20230527222600068" style="zoom:50%;" align="left"/>

三个特殊地址块：

- n=32 主机路由
- n=31 用于点对点链路
- n=0 且全0 用于默认路由



CIDR地址块**可以包含多个分类地址**——构造超网

- 如：128.14.35.7/20所在的地址块包含2^32-20^ / 2^8^ =16个C类**（主机数）**

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527222657155.png" alt="image-20230527222657155" style="zoom:50%;" align="left"/>

在路由器的转发表中，用一个较大的地址块代替许多小的地址块——**路由聚合**

- **路由器根据目的主机所连接的网络前缀（地址块）来查表和转发分组**

- 如网络206.0.68.0/25, 206.0.68.128/25, 206.0.69.0/25 ,206.69.128/25,这四个网络的**网络前缀的前23位都相同**，在路由表中可以聚合为网络206.0.68.0/23。

<img src="C:\Users\86188\AppData\Local\Temp\WeChat Files\897e37ed98756a187e6726b010a4a3b.jpg" alt="897e37ed98756a187e6726b010a4a3b" style="zoom:30%;" align="left"/>

==构造超网和路由聚合都能压缩转发表的大小 ，方便路由器查表==

==网络前缀越短，地址块包含的主机数就越多==

- 路由器查表转发分组时，优先选择网络前缀最长的（更具体）进行比对——**最长前缀匹配**



---

##### IP地址的特点

>- 每个IP地址都由网络前缀和主机号两部分组成。
>  - 路由器根据目的主机所连接的**网络前缀（地址块）**来查表和转发分组
>
>- IP地址是标志一台主机（或路由器）和一条链路的**接口**。
>  - 接入多个网络——多个接口——多个IP地址
>
>- 转发器或交换机连接起来的若干个局域网仍为一个网络
>
>
>- 在IP地址中，所有分配到网络前缀的网络都平等的。

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230527223530004.png" alt="image-20230527223530004" style="zoom:70%;" align="left"/>

```
同一个局域网上的主机或路由器的IP 地址中的网络号必须一样。

路由器的每一个接口都有一个不同网络号的IP地址。

两个路由器直接相连的接口处，可指明也可不指明IP地址。如指明IP地址，则这一段连线就构成了一种只包含一段线路的特殊“网络” 。这种网络仅需两个IP地址，可以使用 /31地址块。主机号可以是0或1
```

#### 4.2.3IP地址和MAC地址

分组每进过一个路由器的转发，其在数据链路层的MAC帧的目的地址和源地址都会发生变化。
整个转发过程中，在网络层的目的IP和源IP都保持不变

两个问题：

- 路由器怎么知道MAC帧的首部填入什么样的地址（**怎么知道下一跳**）
- 路由器中的**路由表**是怎么得到的



#### 4.2.4==地址解析协议ARP==（IP地址->MAC地址）

已知机器的IP地址，求MAC地址

- 解决方案：在主机的ARP高速缓存中存放一个**从IP地址映射到MAC地址的映射表**（==同一个局域网？？？？==中的主机或路由器）
- 广播APR请求分组（匹配IP地址的主机回发MAC地址）

<img src="C:\Users\86188\AppData\Roaming\Typora\typora-user-images\image-20230605202815952.png" alt="image-20230605202815952" style="zoom:80%;" align="left"/>

>- 发送方是主机，要把 IP 数据报发送到**本网络上**的另一个主机。这时用 ARP 找到目的主机的硬件地址。 
>- 发送方是主机，要把 IP 数据报发送到**另一个网络上**的一个主机。这时用 ARP 找到本网络上的一个==路由器==的硬件地址。剩下的工作由这个路由器来完成。 
>- 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。
>- 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。 
>
>**判断目的主机是否在本网络**：目的地址与源主机的子网掩码做逐位与运算，比较结果和源主机的网络地址

- ARP请求——广播 
- ARP响应——单播



#### **4.2.5IP数据报的格式**

**具体格式**：==首部（固定字段20B，可选字段，填充字段） + 数据部分==

- 以32比特为单位(`首部和数据部分都是32比特的整数倍`)
- 



<img src="D:\我的文档\Typora\笔记\笔记图片\屏幕截图 2023-07-13 131058.png" alt="屏幕截图 2023-07-13 131058" style="zoom:50%;" align="left"/>

**各个字段的具体意义**：

>| 名称            | 意义                                                 | 备注                                                         |
>| --------------- | ---------------------------------------------------- | ------------------------------------------------------------ |
>| 版本            | 协议IP的版本（IPv4,IPv6）                            | 占4位，规定通信双方必须使用相同的IP协议                      |
>| 首部长度        | 表示IP数据报的首部长度                               | 占4位，==**单位4B**==——首部最大60B                           |
>| 区分服务        | 暂未使用                                             | 暂未使用                                                     |
>| **总长度**      | 首部和数据部分的总长度                               | 占16位，==**单位B**==——IP数据报最长65535B<br />`若总长度大于数据链路层的MTU，则需要进行分片` |
>| **标识**        | 加一表示产生一个新的IP数据报（**不是序号**）         | 占16位，数据报分片后得到的**各个数据报片标识不变**           |
>| **标志**        | MF(还有分片)，DF(不能再分片)                         | 占3位，空一位不用(只有当DF=0时才能分片)                      |
>| **片偏移**      | 数据报片相对于原数据报的数据字段起点的偏移量         | 占13位，==**单位8B**==（`分片的数据字段长度必须是8B的整数倍`） |
>| 生存时间（TTL） | 意为“跳数限制”，即该数据报目前至多还能经过多少路由器 | 占8位，==每经过一次路由器转发，TTL-1==                       |
>| 协议            | 该数据报的数据字段适用何种协议                       | 占8位，各协议与协议字段值见下表1                             |
>| 首部检验和      | 检验数据部分                                         | 占16位，==每经过一次路由器转发，重新计算校验和==，采用二进制反码求和（每16位）的方式 |
>| 源地址          | 源主机的IP地址                                       | 占32位，转发过程中不会变(`除非涉及到通道、NAT`)              |
>| 目的地址        | 目的主机的IP地址                                     | 占32位，转发过程中不会变(`除非涉及到通道、NAT`)              |
>| 可变部分        | 选项字段，用于支持排错、测量以及安全等措施           | 1B~40B                                                       |
>| 填充            | 保证首部以32比特为单位                               |                                                              |
>
>由上可知，==**每经过一次路由器转发，改变的字段有：**==
>
>- 目的MAC地址，源MAC地址
>- 数据报首部的TTL和首部检验和
>
><img src="D:\我的文档\Typora\笔记\笔记图片\屏幕截图 2023-07-13 134828.png" alt="屏幕截图 2023-07-13 134828" style="zoom:50%;" align="left"/>
>
>IP数据报的“差错检验”过程
>
>> <img src="D:\我的文档\Typora\笔记\笔记图片\屏幕截图 2023-07-13 134848.png" alt="屏幕截图 2023-07-13 134848" style="zoom:50%;" align="left"/>

##### ==数据报分片==

>- 若数据报总长度大于数据链路层的MTU，则需要进行分片
>- 分的是数据部分，每个分片都要加上首部（分组转发）
>- 计算片偏移时，若不能整除，减小分片的长度直至能够被8整除
>
><img src="D:\My Files\笔记\笔记图片\屏幕截图 2023-07-13 135802.png" alt="屏幕截图 2023-07-13 135802" style="zoom:60%;" align="left"/>
>
>
><img src="D:\我的文档\Typora\笔记\笔记图片\屏幕截图 2023-07-13 135817.png" alt="屏幕截图 2023-07-13 135817" style="zoom:67%;" align="left"/>

### 4.3IP层转发分组的过程

### 4.4网际控制报文协议ICMP

### 4.5IPv6

### 4.6==互联网的路由选择协议==

### 4.7IP多播

### 4.8VPN,NAT

### 4.9多协议标签交换

### 4.10软件定义网络SDN

- 路由器转发过程
- 路由选择算法
  - IGP
    - RIP
      - RIP更新路由表
    - OSPF
  - EGP
    - BGP-4
- IP多播
- 专用网
  - VPN
  - NAT网络地址转换（本地IP->全球IP）





